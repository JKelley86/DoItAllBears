<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Date Night Picker üíï</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
  background: linear-gradient(135deg, #ff758c, #ff7eb3);
  color: #fff;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
}

#app {
  width: 95%;
  max-width: 420px;
  text-align: center;
}

.card {
  background: #fff;
  color: #333;
  border-radius: 20px;
  padding: 24px;
  box-shadow: 0 15px 30px rgba(0,0,0,0.25);
  min-height: 260px;
  transition: transform 0.2s ease;
}

h2 {
  margin-top: 0;
}

.buttons {
  display: flex;
  justify-content: space-between;
  margin-top: 20px;
}

button {
  width: 45%;
  padding: 14px;
  border-radius: 30px;
  border: none;
  font-size: 18px;
  cursor: pointer;
}

.no { background: #ddd; }
.yes { background: #ff4d6d; color: white; }

.hidden { display: none; }

.match {
  font-size: 28px;
  font-weight: bold;
  margin-bottom: 20px;
}

/* Reset button */
#resetBtn {
  margin-top: 15px;
  padding: 10px 20px;
  border-radius: 20px;
  border: none;
  background: #555;
  color: #fff;
  cursor: pointer;
}
</style>
</head>

<body>
<div id="app">

<!-- USER SELECT -->
<div id="userSelect" class="card">
  <h2>Who are you?</h2>
  <button onclick="setUser('justin')">Justin</button><br><br>
  <button onclick="setUser('bridget')">Bridget</button>
</div>

<!-- CARD VIEW -->
<div id="cardView" class="card hidden">
  <h2 id="name">Loading...</h2>
  <p id="cuisine"></p>

  <div class="buttons">
    <button class="no" onclick="swipe(false)">‚ùå No</button>
    <button class="yes" onclick="swipe(true)">‚ù§Ô∏è Yes</button>
  </div>
</div>

<!-- MATCH VIEW -->
<div id="matchView" class="card hidden">
  <div class="match">üéâ MATCH!</div>
  <h2 id="matchName"></h2>
  <button class="yes" onclick="openMaps()">Open in Maps</button>
</div>

<!-- RESET BUTTON -->
<button id="resetBtn" onclick="resetDateNight()">Reset Date Night</button>

</div>

<script>
// ================= FIREBASE CONFIG =================
const firebaseConfig = {
  apiKey: "AIzaSyBytsujikovxmALWlt3VQhgzri9306x2TY",
  authDomain: "plc-dashboard-99f31.firebaseapp.com",
  projectId: "plc-dashboard-99f31"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const docRef = db.collection("dateNight").doc("choices");

// ================= STATE =================
let USER = null;
let restaurants = [];
let index = 0;
let matchedRestaurant = null;

// Swipe tracking
let startX = 0;
let currentX = 0;
let isDragging = false;

// ================= USER SELECT =================
function setUser(name) {
  USER = name;
  document.getElementById("userSelect").classList.add("hidden");
  init();
}

// ================= INIT =================
function init() {
  navigator.geolocation.getCurrentPosition(pos => {
    fetchRestaurants(pos.coords.latitude, pos.coords.longitude);
  });

  docRef.onSnapshot(snap => {
    const data = snap.data();
    if (data?.match) showMatch(data.match);
  });
}

// ================= RESTAURANTS =================
async function fetchRestaurants(lat, lng) {
  const RADII = [3000, 6000, 10000, 16100];
  const URLS = [
    "https://overpass.kumi.systems/api/interpreter",
    "https://overpass.nchc.org.tw/api/interpreter"
  ];

  for (const radius of RADII) {
    for (const url of URLS) {
      const query = `
      [out:json][timeout:25];
      (
        node["amenity"="restaurant"](around:${radius}, ${lat}, ${lng});
        node["amenity"="fast_food"](around:${radius}, ${lat}, ${lng});
      );
      out;
      `;

      try {
        const res = await fetch(url, { method: "POST", body: query });
        if (!res.ok) continue;

        const data = await res.json();
        const found = data.elements.filter(r => r.tags?.name);

        if (found.length) {
          restaurants = found;
          showCard();
          return;
        }
      } catch {}
    }
  }

  alert("No restaurants found within 10 miles üòï");
}

// ================= UI =================
function showCard() {
  if (index >= restaurants.length) return;

  const r = restaurants[index];
  const card = document.getElementById("cardView");

  document.getElementById("cardView").classList.remove("hidden");
  document.getElementById("name").textContent = r.tags.name;
  document.getElementById("cuisine").textContent =
    r.tags.cuisine ? "üç¥ " + r.tags.cuisine : "";

  card.style.transform = "translateX(0)";
}

// ================= SWIPE =================
async function swipe(yes) {
  const r = restaurants[index];
  index++;

  if (yes) {
    await docRef.set({
      [USER]: firebase.firestore.FieldValue.arrayUnion(r.id)
    }, { merge: true });

    checkMatch(r.id, r);
  }

  showCard();
}

// ================= MATCH =================
async function checkMatch(id, restaurant) {
  const snap = await docRef.get();
  const data = snap.data();
  const other = USER === "justin" ? "bridget" : "justin";

  if (data?.[other]?.includes(id)) {
    await docRef.set({ match: restaurant }, { merge: true });
  }
}

function showMatch(r) {
  matchedRestaurant = r;
  document.getElementById("cardView").classList.add("hidden");
  document.getElementById("matchView").classList.remove("hidden");
  document.getElementById("matchName").textContent = r.tags.name;
}

function openMaps() {
  window.open(
    `https://www.google.com/maps/search/?api=1&query=${matchedRestaurant.lat},${matchedRestaurant.lon}`,
    "_blank"
  );
}

// ================= RESET =================
function resetDateNight() {
  docRef.set({
    justin: [],
    bridget: [],
    match: null
  }).then(() => {
    alert("Date night reset! You can start swiping again.");
    index = 0;
    restaurants = [];
    matchedRestaurant = null;
    document.getElementById("cardView").classList.add("hidden");
    document.getElementById("matchView").classList.add("hidden");
    document.getElementById("userSelect").classList.remove("hidden");
  });
}

// ================= SWIPE EVENTS =================
const card = document.getElementById("cardView");

card.addEventListener("touchstart", e => {
  startX = e.touches[0].clientX;
  isDragging = true;
});

card.addEventListener("touchmove", e => {
  if (!isDragging) return;
  currentX = e.touches[0].clientX;
  card.style.transform = `translateX(${currentX - startX}px) rotate(${(currentX - startX)/20}deg)`;
});

card.addEventListener("touchend", handleSwipe);

card.addEventListener("mousedown", e => {
  startX = e.clientX;
  isDragging = true;
});

card.addEventListener("mousemove", e => {
  if (!isDragging) return;
  currentX = e.clientX;
  card.style.transform = `translateX(${currentX - startX}px) rotate(${(currentX - startX)/20}deg)`;
});

card.addEventListener("mouseup", handleSwipe);
card.addEventListener("mouseleave", () => isDragging = false);

function handleSwipe() {
  if (!isDragging) return;
  isDragging = false;

  const deltaX = currentX - startX;
  card.style.transform = "translateX(0)";

  if (deltaX > 80) swipe(true);
  else if (deltaX < -80) swipe(false);
}
</script>
</body>
</html>
