<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Password Tracker</title>
<link rel="stylesheet" href="../theme.css">

<!-- Firebase -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
  import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: "AIzaSyBJaG8JkfOSeYoXR1NbFtBhL-CqYr0CmTQ",
    authDomain: "knowledge-base-7bdfc.firebaseapp.com",
    projectId: "knowledge-base-7bdfc",
    storageBucket: "knowledge-base-7bdfc.firebasestorage.app",
    messagingSenderId: "893440933651",
    appId: "1:893440933651:web:c17ad223a164a1724ee4e6"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  window.db = db;
</script>

<!-- CryptoJS for AES encryption/decryption -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<style>
body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
h1 { color: #0077cc; }
table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
th, td { border: 1px solid #ccc; padding: 10px; text-align: left; }
th { background: #0077cc; color: white; }
tr:nth-child(even) { background: #f2f2f2; }
input, select { padding: 8px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
button { padding: 8px 12px; cursor: pointer; background: #0077cc; color: white; border: none; border-radius: 5px; }
button:hover { background: #005999; }
.form-container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
.actions button { margin-right: 5px; }
</style>
</head>
<body>

<button class="menu-btn" onclick="toggleSidebar()">â˜° Menu</button>
<div class="sidebar" id="sidebar">
    <div class="clock" id="clock"></div>
    <div id="sidebar-nav"></div>
    <button class="theme-toggle" onclick="toggleTheme()">ðŸŒ“ Toggle Theme</button>
</div>

<h1>Password Tracker</h1>

<div class="form-container">
  <h3>Add / Edit Password</h3>
  <input type="hidden" id="password-id">
  <label>Owner</label>
  <select id="owner">
    <option value="Justin">Justin</option>
    <option value="Bridget">Bridget</option>
  </select>
  <label>Service / Site</label>
  <input type="text" id="service" placeholder="Gmail, Bank, etc.">
  <label>Username</label>
  <input type="text" id="username">
  <label>Password</label>
  <input type="text" id="password">
  <button id="save-btn">Save Password</button>
  <button id="cancel-btn" style="background:#888;">Cancel</button>
</div>

<input type="text" id="search" placeholder="Search services..." style="padding:8px; width:100%; margin-bottom:10px;">

<table>
  <thead>
    <tr>
      <th>Owner</th>
      <th>Service</th>
      <th>Username</th>
      <th>Password</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="password-table">
    <tr><td colspan="5" style="text-align:center;">Loading...</td></tr>
  </tbody>
</table>

<script type="module">
  import { collection, getDocs, addDoc, updateDoc, deleteDoc, doc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

  const db = window.db;
  const tableBody = document.getElementById('password-table');

  let passwords = [];
  let encryptionKey = prompt("Enter encryption key:");

  function encrypt(text) {
      return CryptoJS.AES.encrypt(text, encryptionKey).toString();
  }

  function decrypt(cipher) {
      try {
          return CryptoJS.AES.decrypt(cipher, encryptionKey).toString(CryptoJS.enc.Utf8);
      } catch {
          return "Invalid Key";
      }
  }

  async function loadPasswords() {
      const snapshot = await getDocs(collection(db, 'passwords'));
      passwords = [];
      snapshot.forEach(docSnap => {
          passwords.push({ id: docSnap.id, ...docSnap.data() });
      });
      renderTable();
  }

  function renderTable() {
      const searchTerm = document.getElementById('search').value.toLowerCase();
      tableBody.innerHTML = '';
      const filtered = passwords.filter(p => 
          p.service.toLowerCase().includes(searchTerm) || 
          p.username.toLowerCase().includes(searchTerm) ||
          p.owner.toLowerCase().includes(searchTerm)
      );
      if (filtered.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No passwords found.</td></tr>';
          return;
      }
      filtered.forEach(p => {
          tableBody.innerHTML += `
              <tr>
                  <td>${p.owner}</td>
                  <td>${p.service}</td>
                  <td>${p.username}</td>
                  <td>${decrypt(p.password)}</td>
                  <td class="actions">
                      <button onclick="editPassword('${p.id}')">Edit</button>
                      <button onclick="deletePassword('${p.id}')">Delete</button>
                  </td>
              </tr>
          `;
      });
  }

  window.editPassword = (id) => {
      const p = passwords.find(x => x.id === id);
      if (!p) return;
      document.getElementById('password-id').value = p.id;
      document.getElementById('owner').value = p.owner;
      document.getElementById('service').value = p.service;
      document.getElementById('username').value = p.username;
      document.getElementById('password').value = decrypt(p.password);
  };

  window.deletePassword = async (id) => {
      if (!confirm('Are you sure you want to delete this password?')) return;
      await deleteDoc(doc(db, 'passwords', id));
      loadPasswords();
  };

  document.getElementById('cancel-btn').addEventListener('click', () => {
      document.getElementById('password-id').value = '';
      document.getElementById('owner').value = 'Justin';
      document.getElementById('service').value = '';
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
  });

  document.getElementById('save-btn').addEventListener('click', async () => {
      const id = document.getElementById('password-id').value;
      const owner = document.getElementById('owner').value;
      const service = document.getElementById('service').value.trim();
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();

      if (!service || !username || !password) {
          alert("Service, username, and password are required.");
          return;
      }

      const data = {
          owner,
          service,
          username,
          password: encrypt(password),
          lastUpdated: serverTimestamp()
      };

      if (id) {
          await updateDoc(doc(db, 'passwords', id), data);
      } else {
          await addDoc(collection(db, 'passwords'), data);
      }

      document.getElementById('cancel-btn').click();
      loadPasswords();
  });

  document.getElementById('search').addEventListener('input', renderTable);

  // Sidebar and clock functions
  function navigateTo(page){ window.location.href = page; }
  window.toggleSidebar = function() { document.getElementById('sidebar').classList.toggle('open'); }
  function updateClock() { document.getElementById('clock').textContent = new Date().toLocaleTimeString(); }
  function toggleTheme() {
      document.body.classList.toggle('light-mode');
      localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
  }
  setInterval(updateClock, 1000); updateClock();

  // Load sidebar
  fetch('sidebar.html')
    .then(res => res.text())
    .then(data => {
        const sidebarNav = document.getElementById('sidebar-nav');
        sidebarNav.innerHTML = data;
        sidebarNav.querySelectorAll('.sidebar-card').forEach(card => {
            card.addEventListener('click', () => {
                const page = card.getAttribute('onclick')?.match(/navigateTo\('(.+?)'\)/)?.[1];
                if(page) navigateTo(page);
            });
        });
    });

  // Load passwords
  loadPasswords();
</script>
</body>
</html>
