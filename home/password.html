<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Password Tracker</title>
<link rel="stylesheet" href="../theme.css">

<!-- Firebase -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
  import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
  import { AES, enc } from 'https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js';

  const firebaseConfig = {
    apiKey: "AIzaSyBJaG8JkfOSeYoXR1NbFtBhL-CqYr0CmTQ",
    authDomain: "knowledge-base-7bdfc.firebaseapp.com",
    projectId: "knowledge-base-7bdfc",
    storageBucket: "knowledge-base-7bdfc.firebasestorage.app",
    messagingSenderId: "893440933651",
    appId: "1:893440933651:web:c17ad223a164a1724ee4e6"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  window.db = db;
</script>

<style>
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 10px; text-align: left; }
  th { background: #a1a1a1; color: white; }
  tr:nth-child(even) { background: #f2f2f2; }
  input, select { padding: 8px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
  button { padding: 8px 12px; cursor: pointer; background: #a1a1a1; color: white; border: none; border-radius: 5px; }
  button:hover { background: #e03e00; }
  .form-container { background: #a1a1a1; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; color: white; }
  .actions button { margin-right: 5px; }
  .filter-container { margin-top: 20px; }
</style>
</head>
<body>

<button class="menu-btn" onclick="toggleSidebar()">â˜° Menu</button>
<div class="sidebar" id="sidebar">
    <div class="clock" id="clock"></div>
    <div id="sidebar-nav"></div>
    <button class="theme-toggle" onclick="toggleTheme()">ðŸŒ“ Toggle Theme</button>
</div>

<h1>Password Tracker</h1>

<div class="form-container">
  <h3>Add / Edit Password</h3>
  <input type="hidden" id="password-id">
  <label>Owner</label>
  <select id="owner">
    <option value="Justin">Justin</option>
    <option value="Bridget">Bridget</option>
  </select>

  <label>Account</label>
  <input type="text" id="account" placeholder="Gmail, Netflix, etc.">

  <label>Username</label>
  <input type="text" id="username">

  <label>Password</label>
  <input type="text" id="password">

  <button id="save-btn">Save</button>
  <button id="cancel-btn" style="background:#888;">Cancel</button>
</div>

<div class="filter-container">
  <label>Filter by Owner:</label>
  <select id="owner-filter">
    <option value="">All</option>
    <option value="Justin">Justin</option>
    <option value="Bridget">Bridget</option>
  </select>
</div>

<table>
  <thead>
    <tr>
      <th>Owner</th>
      <th>Account</th>
      <th>Username</th>
      <th>Password</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="password-table">
    <tr><td colspan="5" style="text-align:center;">Loading...</td></tr>
  </tbody>
</table>

<script type="module">
import { collection, getDocs, addDoc, updateDoc, deleteDoc, doc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
import { AES, enc } from 'https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js';

const db = window.db;
const tableBody = document.getElementById('password-table');

// Prompt for master password
let ENCRYPTION_KEY = prompt("Enter master password:");
if (!ENCRYPTION_KEY) {
    alert("Master password required!");
    document.body.innerHTML = "<h2>Access Denied</h2>";
}

// Password array
let passwords = [];

async function loadPasswords() {
  const snapshot = await getDocs(collection(db, 'passwords'));
  passwords = [];
  snapshot.forEach(docSnap => {
    passwords.push({ id: docSnap.id, ...docSnap.data() });
  });
  renderTable();
}

function renderTable() {
  const ownerFilter = document.getElementById('owner-filter').value;
  tableBody.innerHTML = '';
  const filtered = ownerFilter ? passwords.filter(p => p.owner === ownerFilter) : passwords;

  if (filtered.length === 0) {
    tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No passwords saved.</td></tr>';
    return;
  }

  filtered.forEach(p => {
    const decrypted = AES.decrypt(p.password, ENCRYPTION_KEY).toString(enc.Utf8);
    tableBody.innerHTML += `
      <tr>
        <td>${p.owner}</td>
        <td>${p.account}</td>
        <td>${p.username}</td>
        <td>${decrypted}</td>
        <td class="actions">
          <button onclick="editPassword('${p.id}')">Edit</button>
          <button onclick="deletePassword('${p.id}')">Delete</button>
        </td>
      </tr>
    `;
  });
}

window.editPassword = (id) => {
  const p = passwords.find(x => x.id === id);
  if (!p) return;
  document.getElementById('password-id').value = p.id;
  document.getElementById('owner').value = p.owner;
  document.getElementById('account').value = p.account;
  document.getElementById('username').value = p.username;
  document.getElementById('password').value = AES.decrypt(p.password, ENCRYPTION_KEY).toString(enc.Utf8);
};

window.deletePassword = async (id) => {
  if (!confirm('Are you sure you want to delete this password?')) return;
  await deleteDoc(doc(db, 'passwords', id));
  loadPasswords();
};

document.getElementById('cancel-btn').addEventListener('click', () => {
  document.getElementById('password-id').value = '';
  document.getElementById('account').value = '';
  document.getElementById('username').value = '';
  document.getElementById('password').value = '';
});

document.getElementById('save-btn').addEventListener('click', async () => {
  const id = document.getElementById('password-id').value;
  const owner = document.getElementById('owner').value;
  const account = document.getElementById('account').value.trim();
  const username = document.getElementById('username').value.trim();
  const passwordVal = document.getElementById('password').value.trim();

  if (!account || !username || !passwordVal) {
    alert('Account, username, and password are required.');
    return;
  }

  const encrypted = AES.encrypt(passwordVal, ENCRYPTION_KEY).toString();

  const data = { owner, account, username, password: encrypted, lastUpdated: serverTimestamp() };

  if (id) {
    await updateDoc(doc(db, 'passwords', id), data);
  } else {
    await addDoc(collection(db, 'passwords'), data);
  }

  document.getElementById('cancel-btn').click();
  loadPasswords();
});

// Filter change
document.getElementById('owner-filter').addEventListener('change', renderTable);

// Sidebar and theme
function navigateTo(page) { window.location.href = page; }
window.toggleSidebar = () => { document.getElementById('sidebar').classList.toggle('open'); };
function toggleTheme() {
  document.body.classList.toggle('light-mode');
  localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
}

// Load theme and sidebar
const savedTheme = localStorage.getItem('theme');
if (savedTheme === 'light') document.body.classList.add('light-mode');

fetch('sidebar.html')
  .then(r => r.text())
  .then(data => {
      const sidebarNav = document.getElementById('sidebar-nav');
      sidebarNav.innerHTML = data;
      sidebarNav.querySelectorAll('.sidebar-card').forEach(card => {
          card.addEventListener('click', () => {
              const page = card.getAttribute('onclick')?.match(/navigateTo\('(.+?)'\)/)?.[1];
              if (page) navigateTo(page);
          });
      });
  });

function updateClock() {
  document.getElementById('clock').textContent = new Date().toLocaleTimeString();
}
setInterval(updateClock, 1000);
updateClock();

// Load passwords
if (ENCRYPTION_KEY) loadPasswords();
</script>

</body>
</html>
