<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Knowledge Base</title>

  <!-- Quill -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

  <style>
    :root { --bg:#f4f6f8; --card:#fff; --accent:#0f172a; --muted:#64748b; --primary:#2563eb; }
    body { margin:0; font-family:Inter, Arial, sans-serif; background:var(--bg); color:var(--accent); }
    .app { display:flex; height:100vh; }
    .left { width:320px; border-right:1px solid #e6e9ee; padding:18px; box-sizing:border-box; background:#0b1320; color:white; overflow:auto; }
    .left h1 { margin:0 0 14px; font-size:18px; }
    .search { width:100%; padding:8px; border-radius:6px; border:none; margin-bottom:12px; }
    .folder { background:transparent; margin-bottom:10px; border-radius:8px; }
    .folder-header { display:flex; justify-content:space-between; align-items:center; padding:10px; cursor:pointer; border-radius:6px; }
    .folder-header:hover { background:rgba(255,255,255,0.03); }
    .folder-title { font-weight:600; }
    .topic-list { padding-left:8px; display:none; margin-top:6px; }
    .topic-item { display:flex; justify-content:space-between; align-items:center; padding:8px; border-radius:6px; cursor:pointer; color:#e6eef9; }
    .topic-item:hover { background: rgba(255,255,255,0.02); }
    .topic-name { flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; padding-right:8px; }
    .topic-actions { margin-left:6px; display:flex; gap:6px; }
    .btn { background:var(--primary); color:white; border:none; padding:8px 10px; border-radius:6px; cursor:pointer; }
    .btn.ghost { background:transparent; border:1px solid rgba(255,255,255,0.08); color:#cfe3ff; }
    .right { flex:1; padding:20px; box-sizing:border-box; overflow:auto; }
    .page-header { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px; }
    .page-title { font-size:20px; margin:0; }
    .meta { color:var(--muted); font-size:12px; }
    .viewer { background:var(--card); padding:16px; border-radius:8px; min-height:360px; border:1px solid #e6e9ee; }
    .editor-area { display:none; background:var(--card); padding:12px; border-radius:8px; border:1px solid #e6e9ee; }
    .top-controls { display:flex; gap:8px; }
    .small { padding:6px 8px; font-size:13px; }
    .no-selection { color:var(--muted); }
  </style>
</head>
<body>
  <div class="app">
    <div class="left">
      <h1>Knowledge Base</h1>
      <input id="search" class="search" placeholder="Search titles / content..." />

      <div style="display:flex; gap:8px; margin-bottom:12px;">
        <select id="category-select" style="flex:1; padding:8px; border-radius:6px; border:none;">
          <option value="">-- Select category --</option>
        </select>
        <button id="new-page-btn" class="btn small">+ New</button>
      </div>

      <div id="folders"></div>
    </div>

    <div class="right">
      <div class="page-header">
        <div>
          <h2 id="page-title" class="page-title">Select or create a page</h2>
          <div id="page-meta" class="meta"></div>
        </div>
        <div class="top-controls">
          <button id="edit-btn" class="btn ghost small" style="display:none;">Edit</button>
          <button id="save-btn" class="btn small" style="display:none;">Save</button>
          <button id="cancel-btn" class="btn ghost small" style="display:none;">Cancel</button>
          <button id="delete-btn" class="btn ghost small" style="display:none;">Delete</button>
        </div>
      </div>

      <div id="viewer" class="viewer no-selection">No page selected.</div>

      <div id="editor-area" class="editor-area" style="margin-top:12px;">
        <input id="edit-title" placeholder="Page title" style="width:100%; padding:8px; margin-bottom:8px; border-radius:6px; border:1px solid #e6e9ee;">
        <div id="quill" style="height:320px; background:white;"></div>
      </div>
    </div>
  </div>

<script>
  // Replace this with your Apps Script web app URL (use the same one you deployed)
  const API_URL = "https://script.google.com/macros/s/AKfycbwHtT4YHZnss_-8AzeQ6-6mAGuMgoUsxKU1opcsJ3le1e0tB52V085eeyQEbF72_GM6/exec";

  let quill;
  let categoriesData = {}; // { category: [ { title, content, lastUpdated }, ... ] }
  let selectedCategory = "";
  let selectedPage = null; // { category, title, content, lastUpdated }

  // initialize quill
  document.addEventListener("DOMContentLoaded", ()=> {
    quill = new Quill('#quill', { theme: 'snow' });
    loadData();

    // UI handlers
    document.getElementById("new-page-btn").addEventListener("click", onNewPage);
    document.getElementById("save-btn").addEventListener("click", onSave);
    document.getElementById("edit-btn").addEventListener("click", onEdit);
    document.getElementById("cancel-btn").addEventListener("click", onCancel);
    document.getElementById("delete-btn").addEventListener("click", onDelete);
    document.getElementById("search").addEventListener("input", e => renderFolders(e.target.value));
  });

  async function loadData() {
    const res = await fetch(API_URL.replace(/\?.*$/,'' ) + "?sheet=Knowledge%20Base");
    categoriesData = await res.json();
    // populate category select
    const select = document.getElementById("category-select");
    select.innerHTML = "<option value=''>-- Select category --</option>";
    Object.keys(categoriesData).forEach(cat => {
      const opt = document.createElement("option");
      opt.value = cat;
      opt.innerText = cat;
      select.appendChild(opt);
    });
    select.addEventListener("change", () => {
      selectedCategory = select.value;
      renderFolders(document.getElementById("search").value);
    });
    renderFolders();
  }

  function renderFolders(filter="") {
    const container = document.getElementById("folders");
    container.innerHTML = "";
    const search = filter.trim().toLowerCase();

    const cats = Object.keys(categoriesData).sort((a,b)=>a.localeCompare(b));
    cats.forEach(cat => {
      const folder = document.createElement("div");
      folder.className = "folder";

      const header = document.createElement("div");
      header.className = "folder-header";
      const title = document.createElement("div");
      title.className = "folder-title";
      title.innerText = "📁 " + cat;
      header.appendChild(title);

      // count matching topics
      const topics = (categoriesData[cat] || []).filter(t=>{
        if(!search) return true;
        const combined = (t.title + " " + (t.content || "")).toLowerCase();
        return combined.includes(search);
      });
      const countBadge = document.createElement("div");
      countBadge.style.opacity = 0.7;
      countBadge.innerText = topics.length;
      header.appendChild(countBadge);

      folder.appendChild(header);

      const topicList = document.createElement("div");
      topicList.className = "topic-list";
      topicList.style.display = (selectedCategory === "" || selectedCategory === cat) ? "block" : "none";

      topics.forEach(topic => {
        const item = document.createElement("div");
        item.className = "topic-item";

        const name = document.createElement("div");
        name.className = "topic-name";
        name.innerText = topic.title;
        name.title = topic.title;
        name.addEventListener("click", () => openPage(cat, topic));

        const actions = document.createElement("div");
        actions.className = "topic-actions";

        const editBtn = document.createElement("button");
        editBtn.className = "btn ghost small";
        editBtn.innerText = "Open";
        editBtn.addEventListener("click", () => openPage(cat, topic));

        const del = document.createElement("button");
        del.className = "btn ghost small";
        del.style.color = "#ff6b6b";
        del.innerText = "Delete";
        del.addEventListener("click", (ev) => {
          ev.stopPropagation();
          confirmDelete(cat, topic.title);
        });

        actions.appendChild(editBtn);
        actions.appendChild(del);

        item.appendChild(name);
        item.appendChild(actions);
        topicList.appendChild(item);
      });

      // toggle on header click
      header.addEventListener("click", () => {
        topicList.style.display = (topicList.style.display === "none") ? "block" : "none";
      });

      folder.appendChild(topicList);
      container.appendChild(folder);
    });
  }

  function openPage(category, topicObj) {
    selectedCategory = category;
    selectedPage = { category, title: topicObj.title, content: topicObj.content, lastUpdated: topicObj.lastUpdated };
    document.getElementById("page-title").innerText = topicObj.title;
    document.getElementById("page-meta").innerText = `Category: ${category}${topicObj.lastUpdated ? " • Last updated: " + new Date(topicObj.lastUpdated).toLocaleString() : ""}`;
    document.getElementById("viewer").style.display = "block";
    document.getElementById("viewer").innerHTML = topicObj.content || "<em>(empty)</em>";
    document.getElementById("editor-area").style.display = "none";
    document.getElementById("edit-btn").style.display = "inline-block";
    document.getElementById("delete-btn").style.display = "inline-block";
    document.getElementById("save-btn").style.display = "none";
    document.getElementById("cancel-btn").style.display = "none";
  }

  function onNewPage() {
    // require category selected or prompt
    if (!selectedCategory) {
      const sel = document.getElementById("category-select").value;
      if (!sel) {
        const p = prompt("No category selected. Enter new category name (or cancel):");
        if (!p) return;
        selectedCategory = p;
        // refresh categoriesData with the new empty category for immediate UI feedback
        if (!categoriesData[selectedCategory]) categoriesData[selectedCategory] = [];
        loadData(); // reload to update select
      } else {
        selectedCategory = sel;
      }
    }

    selectedPage = null;
    document.getElementById("page-title").innerText = "New Page";
    document.getElementById("page-meta").innerText = `Category: ${selectedCategory}`;
    document.getElementById("viewer").style.display = "none";
    document.getElementById("editor-area").style.display = "block";
    document.getElementById("edit-title").value = "";
    quill.setContents([{ insert: "\n" }]);
    document.getElementById("edit-btn").style.display = "none";
    document.getElementById("save-btn").style.display = "inline-block";
    document.getElementById("cancel-btn").style.display = "inline-block";
    document.getElementById("delete-btn").style.display = "none";
  }

  function onEdit() {
    if (!selectedPage) return;
    document.getElementById("viewer").style.display = "none";
    document.getElementById("editor-area").style.display = "block";
    document.getElementById("edit-title").value = selectedPage.title;
    quill.root.innerHTML = selectedPage.content || "";
    document.getElementById("edit-btn").style.display = "none";
    document.getElementById("save-btn").style.display = "inline-block";
    document.getElementById("cancel-btn").style.display = "inline-block";
  }

  function onCancel() {
    document.getElementById("editor-area").style.display = "none";
    document.getElementById("viewer").style.display = selectedPage ? "block" : "none";
    document.getElementById("edit-btn").style.display = selectedPage ? "inline-block" : "none";
    document.getElementById("save-btn").style.display = "none";
    document.getElementById("cancel-btn").style.display = "none";
  }

  async function onSave() {
    const title = document.getElementById("edit-title").value.trim();
    if (!title) { alert("Please add a page title."); return; }
    const content = quill.root.innerHTML;
    const payload = {
      action: "savePage",
      category: selectedCategory || document.getElementById("category-select").value || "Uncategorized",
      title,
      content
    };

    await fetch(API_URL.replace(/\?.*$/,'' ), {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    // refresh
    await loadData();
    // open newly saved page
    const newTopic = (categoriesData[payload.category] || []).find(t => t.title === title);
    if (newTopic) openPage(payload.category, newTopic);
    else {
      // fallback: show it using local content
      selectedPage = { category: payload.category, title, content, lastUpdated: new Date().toISOString() };
      document.getElementById("viewer").innerHTML = content;
      document.getElementById("viewer").style.display = "block";
      document.getElementById("editor-area").style.display = "none";
    }
  }

  function confirmDelete(category, title) {
    if (!confirm(`Delete "${title}" from ${category}? This cannot be undone.`)) return;
    doDelete(category, title);
  }

  async function doDelete(category, title) {
    const payload = { action: "deletePage", category, title };
    await fetch(API_URL.replace(/\?.*$/,'' ), {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    await loadData();
    // clear viewer if the deleted page was open
    if (selectedPage && selectedPage.title === title && selectedPage.category === category) {
      selectedPage = null;
      document.getElementById("page-title").innerText = "Select or create a page";
      document.getElementById("viewer").innerHTML = "No page selected.";
      document.getElementById("viewer").style.display = "block";
      document.getElementById("edit-btn").style.display = "none";
      document.getElementById("delete-btn").style.display = "none";
    }
  }
</script>
</body>
</html>
