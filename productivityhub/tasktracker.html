<div id="board-container"></div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxG7G0C5wvF_rx0HKiDI8nOcHNcrQz2n-4dtDfbiMYnE9jmMhzvMxNMgCYzuNtWGh-y/exec";

const categories = ["Daily", "Weekly", "Long-Term"];
const types = ["Personal", "Work"];

async function loadTasks() {
  const res = await fetch(API_URL + "?sheet=Task Tracker");
  const data = await res.json();
  renderBoard(data);
}

function renderBoard(tasks) {
  const container = document.getElementById("board-container");
  container.innerHTML = "";

  types.forEach(type => {
    const section = document.createElement("div");
    section.className = "board-section";
    section.innerHTML = `<h2>${type}</h2>`;
    const board = document.createElement("div");
    board.className = "board";

    categories.forEach(cat => {
      const col = document.createElement("div");
      col.className = "column";
      col.dataset.category = type;
      col.dataset.timeframe = cat;
      col.innerHTML = `<h3>${cat}</h3><div class="task-list" id="${type}-${cat}"></div>`;

      // Add task row
      const addDiv = document.createElement("div");
      addDiv.className = "add-task";
      addDiv.innerHTML = `
        <input type="text" placeholder="New task...">
        <input type="date">
        <button>Add</button>
      `;
      addDiv.querySelector("button").addEventListener("click", () => {
        const taskText = addDiv.querySelector("input[type=text]").value.trim();
        const dueDate = addDiv.querySelector("input[type=date]").value;
        if (taskText) {
          addTask(type, cat, taskText, dueDate);
          addDiv.querySelector("input[type=text]").value = "";
          addDiv.querySelector("input[type=date]").value = "";
        }
      });

      col.appendChild(addDiv);
      board.appendChild(col);

      new Sortable(col.querySelector(".task-list"), {
        group: "shared",
        animation: 150,
        onEnd: saveAllTasks
      });
    });

    section.appendChild(board);
    container.appendChild(section);
  });

  // populate tasks
  tasks.forEach(t => {
    const taskDiv = createTaskElement(t.category, t.timeframe, t.task, t.completed, t.dueDate);
    const list = document.getElementById(`${t.category}-${t.timeframe}`);
    if(list) list.appendChild(taskDiv);
  });
}

function createTaskElement(category, timeframe, text, completed=false, dueDate="") {
  const task = document.createElement("div");
  task.className = "task";

  const checkbox = document.createElement("input");
  checkbox.type = "checkbox";
  checkbox.checked = completed;
  checkbox.onchange = saveAllTasks;

  const span = document.createElement("span");
  span.contentEditable = true;
  span.innerText = text;
  span.oninput = saveAllTasks;

  const dateInput = document.createElement("input");
  dateInput.type = "date";
  if(dueDate) dateInput.value = dueDate;
  dateInput.onchange = saveAllTasks;

  const delBtn = document.createElement("button");
  delBtn.innerHTML = '<i class="fas fa-trash"></i>';
  delBtn.onclick = () => { task.remove(); saveAllTasks(); };

  task.appendChild(checkbox);
  task.appendChild(span);
  task.appendChild(dateInput);
  task.appendChild(delBtn);

  // highlight overdue
  if(dueDate && new Date(dueDate) < new Date() && !completed) task.classList.add("overdue");

  return task;
}

async function addTask(category, timeframe, taskText, dueDate="") {
  await fetch(API_URL + "?sheet=Task Tracker", {
    method: "POST",
    body: JSON.stringify({
      action: "addTask",
      category,
      timeframe,
      task: taskText,
      completed: false,
      dueDate
    })
  });
  loadTasks();
}

async function saveAllTasks() {
  const tasks = [];
  document.querySelectorAll(".column").forEach(col => {
    const category = col.dataset.category;
    const timeframe = col.dataset.timeframe;
    col.querySelectorAll(".task").forEach(t => {
      tasks.push({
        action: "addTask",
        category,
        timeframe,
        task: t.querySelector("span").innerText,
        completed: t.querySelector("input[type='checkbox']").checked,
        dueDate: t.querySelector("input[type='date']").value
      });
    });
  });

  await fetch(API_URL + "?sheet=Task Tracker", {
    method: "POST",
    body: JSON.stringify(tasks)
  });

  loadTasks();
}

loadTasks();
</script>
