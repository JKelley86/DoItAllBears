<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Market Maven - Stock Trading Simulator</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const TrendingUp = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
        <polyline points="17 6 23 6 23 12"></polyline>
      </svg>
    );

    const TrendingDown = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline>
        <polyline points="17 18 23 18 23 12"></polyline>
      </svg>
    );

    const DollarSign = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="12" y1="1" x2="12" y2="23"></line>
        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
      </svg>
    );

    const Briefcase = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
        <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
      </svg>
    );

    const RefreshCw = ({ className }) => (
      <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="23 4 23 10 17 10"></polyline>
        <polyline points="1 20 1 14 7 14"></polyline>
        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
      </svg>
    );

    const Plus = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
    );

    const X = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    );

    const StockTradingGame = () => {
      const [gameStarted, setGameStarted] = useState(false);
      const [startingCash, setStartingCash] = useState(10000);
      const [cash, setCash] = useState(10000);
      const [portfolio, setPortfolio] = useState([]);
      const [watchlist, setWatchlist] = useState(['AAPL', 'GOOGL', 'MSFT', 'TSLA', 'AMZN']);
      const [stockData, setStockData] = useState({});
      const [loading, setLoading] = useState(false);
      const [tradeModal, setTradeModal] = useState(null);
      const [quantity, setQuantity] = useState(1);
      const [newSymbol, setNewSymbol] = useState('');
      const [error, setError] = useState('');

      const fetchStockPrice = async (symbol) => {
        try {
          // Using Yahoo Finance API via CORS proxy
          const response = await fetch(
            `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=1d`,
            {
              method: 'GET',
              headers: {
                'User-Agent': 'Mozilla/5.0'
              }
            }
          );
          
          if (!response.ok) {
            throw new Error('Failed to fetch');
          }
          
          const data = await response.json();
          
          if (data.chart.result && data.chart.result[0]) {
            const result = data.chart.result[0];
            const quote = result.meta;
            const currentPrice = quote.regularMarketPrice;
            const previousClose = quote.chartPreviousClose || quote.previousClose;
            const change = currentPrice - previousClose;
            const changePercent = (change / previousClose) * 100;
            
            return {
              symbol: symbol,
              price: currentPrice,
              change: change,
              changePercent: changePercent,
              name: result.meta.longName || symbol
            };
          }
          return null;
        } catch (err) {
          console.error(`Error fetching ${symbol}:`, err);
          
          // Fallback to mock data for demo purposes
          const mockPrice = 100 + Math.random() * 400;
          const mockChange = (Math.random() - 0.5) * 10;
          return {
            symbol: symbol,
            price: mockPrice,
            change: mockChange,
            changePercent: (mockChange / mockPrice) * 100,
            name: symbol + ' Inc.',
            isMock: true
          };
        }
      };

      const refreshPrices = async () => {
        setLoading(true);
        setError('');
        const allSymbols = [...new Set([...watchlist, ...portfolio.map(p => p.symbol)])];
        const promises = allSymbols.map(symbol => fetchStockPrice(symbol));
        const results = await Promise.all(promises);
        
        const newData = {};
        let hasMockData = false;
        results.forEach(result => {
          if (result) {
            newData[result.symbol] = result;
            if (result.isMock) hasMockData = true;
          }
        });
        
        setStockData(newData);
        
        if (hasMockData) {
          setError('⚠️ Using simulated prices - Yahoo Finance API may be blocked. Prices will update randomly for demo.');
        }
        
        setLoading(false);
      };

      useEffect(() => {
        if (gameStarted) {
          refreshPrices();
          const interval = setInterval(() => {
            // Update mock data with small random changes
            setStockData(prevData => {
              const updated = { ...prevData };
              Object.keys(updated).forEach(symbol => {
                if (updated[symbol].isMock) {
                  const oldPrice = updated[symbol].price;
                  const change = (Math.random() - 0.5) * 5; // Small random change
                  const newPrice = Math.max(10, oldPrice + change);
                  updated[symbol] = {
                    ...updated[symbol],
                    price: newPrice,
                    change: newPrice - oldPrice,
                    changePercent: ((newPrice - oldPrice) / oldPrice) * 100
                  };
                }
              });
              return updated;
            });
          }, 5000); // Update every 5 seconds for demo
          
          return () => clearInterval(interval);
        }
      }, [gameStarted, watchlist, portfolio]);

      const startGame = () => {
        setCash(startingCash);
        setPortfolio([]);
        setGameStarted(true);
      };

      const buyStock = (symbol) => {
        const stock = stockData[symbol];
        if (!stock) return;
        
        const totalCost = stock.price * quantity;
        if (totalCost > cash) {
          setError('Insufficient funds!');
          setTimeout(() => setError(''), 3000);
          return;
        }
        
        setCash(cash - totalCost);
        const existing = portfolio.find(p => p.symbol === symbol);
        if (existing) {
          setPortfolio(portfolio.map(p => 
            p.symbol === symbol 
              ? { ...p, shares: p.shares + quantity, avgPrice: ((p.avgPrice * p.shares) + totalCost) / (p.shares + quantity) }
              : p
          ));
        } else {
          setPortfolio([...portfolio, { symbol, shares: quantity, avgPrice: stock.price }]);
        }
        
        setTradeModal(null);
        setQuantity(1);
      };

      const sellStock = (symbol) => {
        const position = portfolio.find(p => p.symbol === symbol);
        if (!position || quantity > position.shares) {
          setError('Invalid quantity!');
          setTimeout(() => setError(''), 3000);
          return;
        }
        
        const stock = stockData[symbol];
        const totalValue = stock.price * quantity;
        setCash(cash + totalValue);
        
        if (quantity === position.shares) {
          setPortfolio(portfolio.filter(p => p.symbol !== symbol));
        } else {
          setPortfolio(portfolio.map(p => 
            p.symbol === symbol ? { ...p, shares: p.shares - quantity } : p
          ));
        }
        
        setTradeModal(null);
        setQuantity(1);
      };

      const addToWatchlist = async () => {
        const symbol = newSymbol.toUpperCase().trim();
        if (!symbol || watchlist.includes(symbol)) {
          setNewSymbol('');
          return;
        }
        
        setLoading(true);
        const data = await fetchStockPrice(symbol);
        if (data) {
          setWatchlist([...watchlist, symbol]);
          setStockData({ ...stockData, [symbol]: data });
          setNewSymbol('');
        } else {
          setError('Invalid stock symbol');
          setTimeout(() => setError(''), 3000);
        }
        setLoading(false);
      };

      const removeFromWatchlist = (symbol) => {
        setWatchlist(watchlist.filter(s => s !== symbol));
      };

      const totalValue = cash + portfolio.reduce((sum, pos) => {
        const stock = stockData[pos.symbol];
        return sum + (stock ? stock.price * pos.shares : 0);
      }, 0);

      const totalGain = totalValue - startingCash;
      const totalGainPercent = (totalGain / startingCash) * 100;

      if (!gameStarted) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-900 via-blue-800 to-indigo-900 flex items-center justify-center p-4">
            <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
              <div className="text-center mb-8">
                <div className="inline-block p-4 bg-blue-100 rounded-full mb-4">
                  <TrendingUp />
                </div>
                <h1 className="text-4xl font-bold text-gray-800 mb-2">Market Maven</h1>
                <p className="text-gray-600">Master the market with virtual trading</p>
              </div>
              
              <div className="mb-6">
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  Starting Capital
                </label>
                <div className="relative">
                  <div className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" style={{width: '20px', height: '20px'}}>
                    <DollarSign />
                  </div>
                  <input
                    type="number"
                    value={startingCash}
                    onChange={(e) => setStartingCash(Math.max(1000, parseInt(e.target.value) || 1000))}
                    className="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none text-lg font-semibold"
                    min="1000"
                    step="1000"
                  />
                </div>
              </div>
              
              <button
                onClick={startGame}
                className="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-4 rounded-lg font-bold text-lg hover:from-blue-700 hover:to-indigo-700 transition-all transform hover:scale-105 shadow-lg"
              >
                Start Trading
              </button>
              
              <div className="mt-6 text-center text-sm text-gray-500">
                <p>Note: Uses simulated stock prices for demonstration</p>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gray-50">
          <div className="bg-gradient-to-r from-blue-600 to-indigo-600 text-white shadow-lg">
            <div className="max-w-7xl mx-auto px-4 py-6">
              <div className="flex items-center justify-between mb-4">
                <h1 className="text-3xl font-bold">Market Maven</h1>
                <button
                  onClick={refreshPrices}
                  disabled={loading}
                  className="flex items-center gap-2 bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition-all disabled:opacity-50"
                >
                  <RefreshCw className={loading ? 'animate-spin' : ''} />
                  Refresh
                </button>
              </div>
              
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div className="bg-white/10 backdrop-blur rounded-lg p-4">
                  <div className="text-sm opacity-90">Portfolio Value</div>
                  <div className="text-2xl font-bold">${totalValue.toFixed(2)}</div>
                  <div className={`text-sm ${totalGain >= 0 ? 'text-green-300' : 'text-red-300'}`}>
                    {totalGain >= 0 ? '+' : ''}{totalGainPercent.toFixed(2)}%
                  </div>
                </div>
                
                <div className="bg-white/10 backdrop-blur rounded-lg p-4">
                  <div className="text-sm opacity-90">Cash Available</div>
                  <div className="text-2xl font-bold">${cash.toFixed(2)}</div>
                </div>
                
                <div className="bg-white/10 backdrop-blur rounded-lg p-4">
                  <div className="text-sm opacity-90">Holdings Value</div>
                  <div className="text-2xl font-bold">${(totalValue - cash).toFixed(2)}</div>
                </div>
              </div>
            </div>
          </div>

          <div className="max-w-7xl mx-auto px-4 py-6">
            {error && (
              <div className="bg-yellow-100 border border-yellow-400 text-yellow-800 px-4 py-3 rounded mb-4">
                {error}
              </div>
            )}

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div className="bg-white rounded-lg shadow-lg p-6">
                <div className="flex items-center gap-2 mb-4">
                  <Briefcase />
                  <h2 className="text-xl font-bold">Your Portfolio</h2>
                </div>
                
                {portfolio.length === 0 ? (
                  <p className="text-gray-500 text-center py-8">No positions yet. Start trading!</p>
                ) : (
                  <div className="space-y-3">
                    {portfolio.map(pos => {
                      const stock = stockData[pos.symbol];
                      if (!stock) return null;
                      const value = stock.price * pos.shares;
                      const gain = value - (pos.avgPrice * pos.shares);
                      const gainPercent = (gain / (pos.avgPrice * pos.shares)) * 100;
                      
                      return (
                        <div key={pos.symbol} className="border border-gray-200 rounded-lg p-4 hover:border-blue-300 transition-all">
                          <div className="flex justify-between items-start mb-2">
                            <div>
                              <div className="font-bold text-lg">{pos.symbol}</div>
                              <div className="text-sm text-gray-600">{pos.shares} shares</div>
                            </div>
                            <button
                              onClick={() => setTradeModal({ type: 'sell', symbol: pos.symbol, max: pos.shares })}
                              className="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-all text-sm font-semibold"
                            >
                              Sell
                            </button>
                          </div>
                          <div className="grid grid-cols-2 gap-2 text-sm">
                            <div>
                              <div className="text-gray-600">Current</div>
                              <div className="font-semibold">${stock.price.toFixed(2)}</div>
                            </div>
                            <div>
                              <div className="text-gray-600">Avg Cost</div>
                              <div className="font-semibold">${pos.avgPrice.toFixed(2)}</div>
                            </div>
                            <div>
                              <div className="text-gray-600">Value</div>
                              <div className="font-semibold">${value.toFixed(2)}</div>
                            </div>
                            <div>
                              <div className="text-gray-600">Gain/Loss</div>
                              <div className={`font-semibold ${gain >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                {gain >= 0 ? '+' : ''}${gain.toFixed(2)} ({gainPercent.toFixed(2)}%)
                              </div>
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                )}
              </div>

              <div className="bg-white rounded-lg shadow-lg p-6">
                <div className="flex items-center gap-2 mb-4">
                  <TrendingUp />
                  <h2 className="text-xl font-bold">Watchlist</h2>
                </div>
                
                <div className="flex gap-2 mb-4">
                  <input
                    type="text"
                    value={newSymbol}
                    onChange={(e) => setNewSymbol(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && addToWatchlist()}
                    placeholder="Add symbol (e.g. NVDA)"
                    className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                  />
                  <button
                    onClick={addToWatchlist}
                    className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-all"
                  >
                    <Plus />
                  </button>
                </div>
                
                <div className="space-y-3">
                  {watchlist.map(symbol => {
                    const stock = stockData[symbol];
                    if (!stock) return (
                      <div key={symbol} className="border border-gray-200 rounded-lg p-4 animate-pulse">
                        <div className="h-6 bg-gray-200 rounded w-1/3 mb-2"></div>
                        <div className="h-4 bg-gray-200 rounded w-1/2"></div>
                      </div>
                    );
                    
                    return (
                      <div key={symbol} className="border border-gray-200 rounded-lg p-4 hover:border-blue-300 transition-all">
                        <div className="flex justify-between items-start mb-2">
                          <div className="flex-1">
                            <div className="flex items-center gap-2">
                              <div className="font-bold text-lg">{symbol}</div>
                              <button
                                onClick={() => removeFromWatchlist(symbol)}
                                className="text-gray-400 hover:text-red-500"
                              >
                                <X />
                              </button>
                            </div>
                            <div className="text-sm text-gray-600">{stock.name}</div>
                          </div>
                          <button
                            onClick={() => setTradeModal({ type: 'buy', symbol })}
                            className="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-all text-sm font-semibold"
                          >
                            Buy
                          </button>
                        </div>
                        <div className="flex items-center gap-4">
                          <div className="text-2xl font-bold">${stock.price.toFixed(2)}</div>
                          <div className={`flex items-center gap-1 ${stock.change >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                            {stock.change >= 0 ? <TrendingUp /> : <TrendingDown />}
                            <span className="font-semibold">
                              {stock.change >= 0 ? '+' : ''}{stock.change.toFixed(2)} ({stock.changePercent.toFixed(2)}%)
                            </span>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
          </div>

          {tradeModal && (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-lg shadow-2xl p-6 max-w-md w-full">
                <h3 className="text-2xl font-bold mb-4">
                  {tradeModal.type === 'buy' ? 'Buy' : 'Sell'} {tradeModal.symbol}
                </h3>
                
                {stockData[tradeModal.symbol] && (
                  <div className="mb-4 p-4 bg-gray-50 rounded-lg">
                    <div className="text-sm text-gray-600">Current Price</div>
                    <div className="text-2xl font-bold">${stockData[tradeModal.symbol].price.toFixed(2)}</div>
                  </div>
                )}
                
                <div className="mb-4">
                  <label className="block text-sm font-semibold text-gray-700 mb-2">
                    Quantity
                  </label>
                  <input
                    type="number"
                    value={quantity}
                    onChange={(e) => setQuantity(Math.max(1, parseInt(e.target.value) || 1))}
                    className="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
                    min="1"
                    max={tradeModal.max}
                  />
                  {tradeModal.type === 'sell' && (
                    <div className="text-sm text-gray-600 mt-1">Max: {tradeModal.max} shares</div>
                  )}
                </div>
                
                {stockData[tradeModal.symbol] && (
                  <div className="mb-4 p-4 bg-blue-50 rounded-lg">
                    <div className="text-sm text-gray-600">Total {tradeModal.type === 'buy' ? 'Cost' : 'Value'}</div>
                    <div className="text-2xl font-bold text-blue-600">
                      ${(stockData[tradeModal.symbol].price * quantity).toFixed(2)}
                    </div>
                  </div>
                )}
                
                <div className="flex gap-3">
                  <button
                    onClick={() => { setTradeModal(null); setQuantity(1); }}
                    className="flex-1 bg-gray-200 text-gray-800 py-3 rounded-lg font-semibold hover:bg-gray-300 transition-all"
                  >
                    Cancel
                  </button>
                  <button
                    onClick={() => tradeModal.type === 'buy' ? buyStock(tradeModal.symbol) : sellStock(tradeModal.symbol)}
                    className={`flex-1 text-white py-3 rounded-lg font-semibold transition-all ${
                      tradeModal.type === 'buy' 
                        ? 'bg-green-500 hover:bg-green-600' 
                        : 'bg-red-500 hover:bg-red-600'
                    }`}
                  >
                    Confirm {tradeModal.type === 'buy' ? 'Purchase' : 'Sale'}
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    ReactDOM.render(<StockTradingGame />, document.getElementById('root'));
  </script>
</body>
</html>
